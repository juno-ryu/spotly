# 창업 분석기 — 시스템 분석 보고서

## 1. 전체 데이터 흐름

```
사용자 입력 (주소, 업종, 반경)
    │
    ▼
┌─ Kakao Geocoding API ─┐
│  주소 → 좌표(위경도)    │
│  좌표 → 법정동코드(5자리)│
└────────────┬───────────┘
             ▼
    ┌────────┼────────┐
    ▼        ▼        ▼         ← 1단계: 3개 API 병렬 호출
  NPS API  부동산 API  KOSIS API
    │        │        │
    ▼        │        │
  상위20개    │        │         ← 2단계: 상세+추이 병렬 조회
  상세/추이   │        │
    │        │        │
    ▼        ▼        ▼
┌──── data-aggregator ────┐
│   데이터 병합 (AggregatedData)   │
└────────────┬────────────┘
             ▼
┌──── scoring-engine ─────┐
│  5개 지표 점수 계산 (100점)   │
└────────────┬────────────┘
             ▼
         DB 저장 → 프론트 표시 → AI 리포트 생성
```

---

## 2. API별 역할

### 2-1. Kakao Geocoding API (카카오 로컬 API)

| 항목 | 내용 |
|------|------|
| **파일** | `src/server/data-sources/kakao-geocoding.ts` |
| **API 키** | `KAKAO_REST_API_KEY` |
| **역할** | 주소↔좌표 변환, 법정동코드 추출 |

**함수 3개:**

| 함수 | 엔드포인트 | 입력 → 출력 | 용도 |
|------|-----------|------------|------|
| `addressToCoord()` | `/search/address` | 주소 → `{latitude, longitude}` | 프론트에서 주소 검색 시 좌표 변환 |
| `coordToRegion()` | `/geo/coord2regioncode` | 좌표 → `{districtCode(5자리), region1~3}` | **핵심**: 좌표를 법정동코드로 변환. 이 코드가 NPS, 부동산, KOSIS API의 지역 파라미터로 사용됨 |
| `searchByKeyword()` | `/search/keyword` | 키워드+좌표 → 장소 목록 | 장소 검색 (현재 미사용) |

**점수 영향**: 직접적인 점수 영향 없음. 다른 API 호출의 **지역코드 기반**을 제공하는 역할.

---

### 2-2. 국민연금 NPS API (공공데이터포털)

| 항목 | 내용 |
|------|------|
| **파일** | `src/server/data-sources/nps-client.ts` |
| **API 키** | `DATA_GO_KR_API_KEY` |
| **베이스 URL** | `apis.data.go.kr/B552015/NpsBplcInfoInqireServiceV2` |
| **역할** | 국민연금 가입 사업장 데이터 → 경쟁업체 현황 파악 |
| **핵심 아이디어** | 국민연금 가입자 수 = 직원 수. 직원 변동 = 사업장 건강 지표 |

**함수 3개:**

| 함수 | 엔드포인트 | 입력 → 출력 | 용도 |
|------|-----------|------------|------|
| `searchBusinesses()` | `/getBassInfoSearchV2` | 시군구코드 + 업종키워드 → 사업장 목록(최대100개) | 해당 지역 동일 업종 경쟁업체 검색. `wkplJnngStcd`로 가입(활성)/탈퇴(폐업) 구분 |
| `getBusinessDetail()` | `/getDetailInfoSearchV2` | 사업장seq → 상세정보 | **직원수(`jnngpCnt`)**, **가입일(`adptDt`)**, 업종코드 등 추출. 상위 20개만 조회 |
| `getMonthlyTrend()` | `/getPdAcctoSttusInfoSearchV2` | 사업장seq + 기간 → 월별 변동 | **신규입사(`nwAcqzrCnt`)**, **퇴사(`lssJnngpCnt`)** 데이터. 사업장 성장/쇠퇴 판단 |

**점수 영향**: **3개 지표에 직접 영향 (총 75점/100점)**

| 지표 | 배점 | NPS 데이터 사용 방식 |
|------|------|---------------------|
| **상권 활력도** | 30점 | 가입일(`adptDt`)로 신규 창업 비율 산출, 직원수(`jnngpCnt`)로 평균 규모, 가입상태로 활성 비율 |
| **경쟁 강도** | 25점 | 검색된 사업장 총 수 → 면적 대비 밀도 계산 |
| **생존율** | 20점 | 가입상태 `1`(활성) vs `2`(탈퇴=폐업) 비율 |

---

### 2-3. 부동산 실거래가 API (국토교통부)

| 항목 | 내용 |
|------|------|
| **파일** | `src/server/data-sources/real-estate-client.ts` |
| **API 키** | `DATA_GO_KR_API_KEY` (NPS와 동일) |
| **베이스 URL** | `apis.data.go.kr/1613000/RTMSDataSvcAptTradeDev` |
| **역할** | 아파트 실거래가 데이터 → 주거 밀도 + 소득 수준 추정 |
| **특이사항** | JSON 미지원, XML로 응답 → 커스텀 XML 파서 사용 |

**함수 2개:**

| 함수 | 용도 |
|------|------|
| `getApartmentTransactions()` | 시군구코드 + 거래년월 → 아파트 거래 내역 배열. 2~3개월 전 데이터 조회 (실거래 데이터 지연 반영) |
| `calculateAveragePrice()` | 거래 내역 → 평균 거래가(만원) 계산 |

**점수 영향**: **2개 지표에 직접 영향 (총 25점/100점)**

| 지표 | 배점 | 부동산 데이터 사용 방식 |
|------|------|----------------------|
| **주거 밀도** | 15점 | 거래 건수(`trades.length`). 거래가 많을수록 = 배후 주거 수요 많음 |
| **소득 수준** | 10점 | 평균 거래가(`avgApartmentPrice`). 전국 평균(4.5억) 대비 비율로 구매력 판단 |

---

### 2-4. KOSIS 통계청 API

| 항목 | 내용 |
|------|------|
| **파일** | `src/server/data-sources/kosis-client.ts` |
| **API 키** | `KOSIS_API_KEY` (별도 발급) |
| **베이스 URL** | `kosis.kr/openapi/Param/statisticsParameterData.do` |
| **역할** | 행정구역별 인구수, 세대수 → 주거 밀도 정밀화 |

**함수 1개:**

| 함수 | 조회 테이블 | 출력 |
|------|-----------|------|
| `getPopulationByDistrict()` | `DT_1B040A3`(인구수, T20) + `DT_1B040B3`(세대수, T1) 병렬 | `{totalPopulation, households}` |

**점수 영향**: **주거 밀도 지표 보강 (15점 내 가중치 변경)**

| KOSIS 데이터 유무 | 주거 밀도(15점) 계산 방식 |
|------------------|------------------------|
| **없을 때** | 아파트 거래 건수 100%로 산출 |
| **있을 때** | 거래 건수 **40%** + 세대수 **35%** + 인구수 **25%** 복합 지표 |

---

### 2-5. Anthropic Claude API

| 항목 | 내용 |
|------|------|
| **파일** | `src/features/report/actions.ts` |
| **API 키** | `ANTHROPIC_API_KEY` |
| **모델** | `claude-haiku-4-5-20251001` |
| **역할** | 수집 데이터 + 점수를 기반으로 자연어 분석 리포트 생성 |

**점수 영향**: 없음 (점수 계산 완료 후 호출). 점수를 **해석**하여 verdict/강점/위험/제언/상세분석 JSON 생성.

---

## 3. 스코어링 엔진 상세

### 총점: 100점 (5개 지표 합산)

```
종합 점수 = 상권활력도(30) + 경쟁강도(25) + 생존율(20) + 주거밀도(15) + 소득수준(10)
```

관련 파일:
- `src/features/analysis/lib/scoring-engine.ts` — 점수 계산 로직
- `src/features/analysis/constants/scoring.ts` — 가중치/임계값 상수

### 3-1. 상권 활력도 (30점) — NPS 데이터

**"주변 가게들이 잘 되고 있는가?"**

3개 하위 지표의 가중 합산:

| 하위 지표 | 가중치 | 계산 방식 | 만점 기준 |
|-----------|--------|----------|----------|
| 신규 창업 비율 | 30% | 최근 24개월 내 `adptDt`(국민연금 가입일) 보유 사업장 / 전체 | 50% 이상이면 만점 |
| 평균 직원 규모 | 40% | 활성 사업장 평균 `jnngpCnt`(직원수) | 20명 이상이면 만점 |
| 활성 비율 | 30% | 활성 사업장 수 / 전체 사업장 수 | 100%면 만점 |

- 사업장 0개인 경우: 15점(중간값) 부여

### 3-2. 경쟁 강도 (25점, 역비례) — NPS 데이터

**"경쟁이 얼마나 치열한가?" (경쟁 적을수록 고득점)**

```
밀도 = 사업장 수 / (π × 반경km²)
기준밀도 = 업종별 상이 (아래 표)
점수 = (기준밀도×2 - 밀도) / (기준밀도×2) × 25
```

| 업종 | 기준밀도(개/km²) | 0점 기준(2배) |
|------|-----------------|--------------|
| 커피전문점 | 15 | 30개/km² |
| 한식음식점 | 12 | 24개/km² |
| 치킨전문점 | 8 | 16개/km² |
| 분식전문점 | 10 | 20개/km² |
| 편의점 | 5 | 10개/km² |
| 미용실 | 8 | 16개/km² |
| 기타 | 10 | 20개/km² |

### 3-3. 생존율 (20점) — NPS 데이터

**"같은 업종 가게들이 살아남고 있는가?"**

```
생존율 = 활성 사업장 수 / (활성 + 폐업)
점수 = (생존율 - 0.5) / (0.9 - 0.5) × 20
```

| 생존율 | 점수 |
|--------|------|
| 90% 이상 | 20점 (만점) |
| 70% | 10점 |
| 50% 이하 | 0점 |

### 3-4. 주거 밀도 (15점) — 부동산 API + KOSIS API

**"배후 주거 수요가 충분한가?"**

**KOSIS 데이터 없는 경우 (부동산 100%):**
```
점수 = (거래건수 - 10) / (200 - 10) × 15
```

**KOSIS 데이터 있는 경우 (복합 지표):**

| 하위 지표 | 가중치 | 산출 | 구간 |
|-----------|--------|------|------|
| 아파트 거래 건수 | 40% | `normalize(건수, 10, 200, 15)` | 10건↓ 0점, 200건↑ 만점 |
| 세대수 | 35% | `normalize(세대수, 5000, 150000, 15)` | 5천↓ 0점, 15만↑ 만점 |
| 인구수 | 25% | `normalize(인구수, 10000, 500000, 15)` | 1만↓ 0점, 50만↑ 만점 |

### 3-5. 소득 수준 (10점) — 부동산 API

**"이 동네 구매력은 어느 수준인가?"**

```
비율 = 평균 아파트 거래가 / 전국 평균(45,000만원)
점수 = (비율 - 0.5) / (2.0 - 0.5) × 10
```

| 평균 거래가 | 비율 | 점수 |
|------------|------|------|
| 9억 이상 | 2.0↑ | 10점 (만점) |
| 4.5억 (전국 평균) | 1.0 | 3.3점 |
| 2.25억 이하 | 0.5↓ | 0점 |

---

## 4. API → 점수 영향 요약 매트릭스

| API | 상권활력도 (30) | 경쟁강도 (25) | 생존율 (20) | 주거밀도 (15) | 소득수준 (10) | 합계 영향 |
|-----|:-:|:-:|:-:|:-:|:-:|:-:|
| **NPS (국민연금)** | **30점** | **25점** | **20점** | - | - | **75점** |
| **부동산 실거래** | - | - | - | **6점** (40%) | **10점** | **16점** |
| **KOSIS (통계청)** | - | - | - | **9점** (60%) | - | **9점** |
| **Kakao (지오코딩)** | 간접 | 간접 | 간접 | 간접 | 간접 | 기반 인프라 |
| **Claude (AI)** | - | - | - | - | - | 리포트만 |

> **NPS API가 전체 점수의 75%를 결정**하는 가장 핵심 데이터 소스입니다. KOSIS가 없으면 부동산 API가 주거밀도 15점 전부를 담당하고, KOSIS가 있으면 더 정밀한 복합 지표로 분산됩니다.

---

## 5. 실제 테스트 결과 (참고)

| 지역 | 업종 | 사업장수 | 종합점수 | 활력도/30 | 경쟁/25 | 생존/20 | 주거/15 | 소득/10 |
|------|------|---------|---------|----------|--------|--------|--------|--------|
| 강남구 | 커피전문점 | 100 | 64.7 | - | - | - | - | - |
| 노원구 공릉동 | 커피전문점 | 21 | 63.2 | 18.9 | 19.4 | 3.6 | 13.6 | 7.7 |

---

## 6. 데이터 수집 파이프라인 상세

### 캐싱 전략 (`src/server/cache/redis.ts`)

모든 외부 API 호출은 Upstash Redis를 통해 캐싱됩니다:

| 캐시 키 패턴 | TTL | 대상 |
|-------------|-----|------|
| `nps:search:{지역코드}:{키워드}` | NPS TTL | 사업장 검색 결과 |
| `nps:detail:{seq}` | NPS TTL | 사업장 상세 |
| `nps:trend:{seq}` | NPS TTL | 월별 추이 |
| `realestate:{지역코드}:{YYYYMM}` | 부동산 TTL | 아파트 거래 |
| `kosis:pop:{지역코드}` | KOSIS TTL (30일) | 인구·세대수 |

### 장애 격리 (Partial Failure Tolerance)

1단계 병렬 호출은 `Promise.allSettled()`를 사용하여, **하나의 API가 실패해도 나머지 데이터로 점수 산출이 가능**합니다:

| 실패 API | 영향 받는 지표 | fallback |
|----------|--------------|----------|
| NPS | 활력도, 경쟁, 생존율 | 사업장 0개 → 각 중간값 부여 |
| 부동산 | 주거밀도, 소득수준 | 거래 0건 → 각 중간값/0점 |
| KOSIS | 주거밀도 보정 | 부동산 데이터만으로 100% 산출 |
